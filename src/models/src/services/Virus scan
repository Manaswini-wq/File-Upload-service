const axios = require('axios');
const FormData = require('form-data');
const fs = require('fs');
const config = require('../config/config');

const scanFile = async (filePath) => {
  const form = new FormData();
  form.append('file', fs.createReadStream(filePath));

  try {
    const response = await axios.post(config.virusScan.apiUrl, form, {
      headers: {
        ...form.getHeaders(),
        'x-apikey': config.virusScan.apiKey,
      },
    });

    return {
      isClean: response.data.data.attributes.stats.malicious === 0,
      scanResult: response.data.data.attributes.results,
    };
  } catch (error) {
    console.error('Virus scan error:', error);
    throw new Error('Failed to scan file for viruses');
  }
};

module.exports = { scanFile };
